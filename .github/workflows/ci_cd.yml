trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - "*"

variables:
- group: Azure

stages:
  - stage: BuildAndPush
    displayName: "Build and Push Docker Image to ACR"
    jobs:
      - job: Build
        displayName: "Build and Push Docker Image"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: $(ServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(ACR_NAME)

                docker build -t $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId) .

                docker push $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)

          - script: |
              echo "Docker image $(IMAGE_NAME):$(Build.BuildId) was successfully pushed to $(ACR_NAME).azurecr.io"
            displayName: "Confirmation Message"